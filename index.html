<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Visor Faixas ‚Äì Galicia</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  
  <!-- FontAwesome para iconos -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Plugins -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-measure@3.1.0/dist/leaflet-measure.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-minimap/3.6.1/Control.MiniMap.min.css" />

  <style>
    /* Reset b√°sico */
    body, html { 
        height: 100%; 
        width: 100%; 
        margin: 0; 
        padding: 0; 
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        overflow: hidden;
    }

    #map { 
        width: 100%; 
        height: 100%; 
        z-index: 1;
    }

    /* --- PANEL DE T√çTULO --- */
    .title-box {
        position: absolute;
        top: 10px;
        left: 10px; 
        z-index: 1000;
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        min-width: 260px;
        transition: all 0.3s ease;
    }

    .title-box h1 {
        margin: 0 0 10px 0;
        font-size: 1.2rem;
        color: #333;
        font-weight: 700;
    }

    /* --- POSICIONAMIENTO CONTROLES LEAFLET --- */
    
    /* ARRIBA IZQUIERDA (Zoom y Regla) */
    .leaflet-top.leaflet-left {
        top: 140px; 
        left: 10px; 
        transition: all 0.3s ease;
    }

    /* ABAJO IZQUIERDA (Minimapa) */
    .leaflet-bottom.leaflet-left {
        left: 10px; 
        bottom: 20px;
        transition: all 0.3s ease;
    }
    
    /* ARRIBA DERECHA (Capas) */
    .leaflet-top.leaflet-right {
        top: 10px;
    }

    /* --- MEDIA QUERIES: AJUSTES PARA M√ìVIL (< 600px) --- */
    @media (max-width: 600px) {
        /* 1. T√≠tulo centrado */
        .title-box {
            left: 50% !important;
            transform: translateX(-50%);
            width: 92%; 
            top: 10px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .title-box h1 {
            font-size: 1.1rem;
            margin-bottom: 8px;
        }

        /* 2. Iconos Arriba Izquierda pegados al borde */
        .leaflet-top.leaflet-left {
            top: 130px !important; 
            left: 0 !important; 
        }

        /* 3. Minimapa Abajo Izquierda pegado al borde */
        .leaflet-bottom.leaflet-left {
            left: 0 !important;
            bottom: 0 !important;
        }

        /* 4. Capas abajo para no tapar t√≠tulo */
        .leaflet-top.leaflet-right {
            top: 130px !important;
        }
    }

    /* Bot√≥n de Localizaci√≥n */
    .locate-prominent-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        width: 100%;
        padding: 10px 15px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s, transform 0.1s;
        box-shadow: 0 2px 5px rgba(0,123,255,0.3);
    }
    .locate-prominent-btn:hover { background: #0056b3; }
    .locate-prominent-btn:active { transform: scale(0.98); }
    .locate-prominent-btn.error { background: #dc3545; }
    .locate-prominent-btn.success { background: #28a745; }

    /* Botones Flotantes */
    .floating-btn {
        background-color: #fff;
        width: 40px;
        height: 40px;
        line-height: 40px;
        text-align: center;
        border-radius: 50%;
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        cursor: pointer;
        color: #333;
        font-size: 18px;
        margin-top: 10px;
        display: block;
        text-decoration: none;
    }
    .ai-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white !important;
        border: 2px solid white;
    }

    /* Ajustes Leaflet */
    .leaflet-control-layers-expanded {
        padding: 10px;
        font-size: 14px;
        max-height: 65vh; 
        overflow-y: auto;
        min-width: 200px;
    }
    
    .leaflet-control-layers label {
        display: flex !important;
        align-items: center !important;
        margin-bottom: 6px !important;
    }
    .leaflet-control-layers-selector {
        margin: 0 8px 0 0 !important;
        transform: scale(1.2); 
    }
    
    /* Colores y Estilos Espec√≠ficos */
    .violet-wms { filter: invert(19%) sepia(96%) saturate(4207%) hue-rotate(277deg) brightness(91%) contrast(109%); }
    .layer-label { display: flex; align-items: center; gap: 8px; }
    .color-box { width: 14px; height: 14px; border-radius: 3px; display: inline-block; flex-shrink: 0; }
    
    /* Popup */
    .info-popup-table td { padding: 3px 8px 3px 0; border-bottom: 1px solid #eee; font-size: 13px; }
    .info-popup-header { font-weight: bold; color: #007bff; margin-bottom: 5px; border-bottom: 2px solid #007bff; padding-bottom: 3px; }
    
    /* Measure Tool Fixes */
    .leaflet-control-measure { border: 2px solid rgba(0,0,0,0.2); box-shadow: none; }
    
    /* Modal IA */
    .ai-modal { display: none; position: fixed; bottom: 80px; right: 10px; width: 350px; max-width: 90vw; background: white; z-index: 2000; border-radius: 12px; box-shadow: 0 5px 25px rgba(0,0,0,0.2); flex-direction: column; border: 1px solid #e0e0e0; font-size: 14px; }
    .ai-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px; display: flex; justify-content: space-between; font-weight: bold; }
    .ai-content { height: 300px; overflow-y: auto; padding: 15px; background: #f9f9f9; display: flex; flex-direction: column; gap: 10px; }
    .message { padding: 8px 12px; border-radius: 8px; max-width: 85%; line-height: 1.4; }
    .msg-user { background: #e3e8ff; align-self: flex-end; color: #333; }
    .msg-ai { background: white; align-self: flex-start; border: 1px solid #ddd; }
    .ai-input-area { padding: 10px; border-top: 1px solid #eee; display: flex; gap: 8px; background: white; }
    .ai-input { flex: 1; border: 1px solid #ddd; border-radius: 20px; padding: 8px; outline: none; }
    .ai-send { background: #764ba2; color: white; border: none; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; }
    .suggestions { display: flex; gap: 5px; flex-wrap: wrap; margin-top: 5px; }
    .chip { background: #eee; font-size: 0.75rem; padding: 4px 8px; border-radius: 12px; cursor: pointer; }

  </style>
</head>
<body>

  <!-- Panel de T√≠tulo -->
  <div class="title-box">
      <h1>Visor Faixas</h1>
      <button id="btnLocateMain" class="locate-prominent-btn">
        <i class="fa-solid fa-location-crosshairs"></i> Centrar
      </button>
  </div>

  <!-- Modal IA -->
  <div id="aiModal" class="ai-modal">
      <div class="ai-header">
          <span><i class="fa-solid fa-robot"></i> Asistente Normativa ‚ú®</span>
          <span style="cursor:pointer" onclick="toggleAI()"><i class="fa-solid fa-xmark"></i></span>
      </div>
      <div class="ai-content" id="chatContainer">
          <div class="message msg-ai">
              Hola, soy tu asistente experto en la Ley de Prevenci√≥n de Incendios de Galicia.
              <div class="suggestions">
                  <span class="chip" onclick="askPreset('Distancia eucaliptos a viviendas')">Distancia eucaliptos</span>
                  <span class="chip" onclick="askPreset('¬øQu√© se puede plantar en la faja de 50m?')">Faja 50m</span>
              </div>
          </div>
      </div>
      <div class="ai-input-area">
          <input type="text" id="userQuery" class="ai-input" placeholder="Duda..." onkeypress="handleEnter(event)">
          <button id="sendBtn" class="ai-send" onclick="callGemini()"><i class="fa-solid fa-paper-plane"></i></button>
      </div>
  </div>

  <div id="map"></div>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="https://unpkg.com/esri-leaflet@3.0.12/dist/esri-leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-measure@3.1.0/dist/leaflet-measure.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-minimap/3.6.1/Control.MiniMap.min.js"></script>

  <script>
    // CONFIGURACI√ìN MAPA
    var galiciaBounds = L.latLngBounds(L.latLng(41.8, -9.6), L.latLng(43.9, -6.2));
    var map = L.map('map', {
        zoomControl: false, 
        maxBounds: galiciaBounds.pad(0.2),
        minZoom: 7
    }).setView([42.88, -8.54], 8);

    // Controles (Zoom y Regla)
    L.control.zoom({ position: 'topleft' }).addTo(map);
    
    var measureControl = new L.Control.Measure({
        position: 'topleft',
        primaryLengthUnit: 'meters', secondaryLengthUnit: 'kilometers',
        primaryAreaUnit: 'sqmeters', activeColor: '#ff0000',
        localization: 'es'
    });
    measureControl.addTo(map);

    // TRADUCCI√ìN DIN√ÅMICA REGLA
    function translateMeasure() {
        const trans = {
            'Measure distances and areas': 'Medir distancias y √°reas',
            'Create a new measurement': 'Crear nueva medici√≥n',
            'Finish measurement': 'Terminar', 'Delete last point': 'Borrar punto', 'Cancel': 'Cancelar',
            'Point location': 'Ubicaci√≥n', 'Linear measurement': 'Longitud', 'Area measurement': '√Årea',
            'Path distance': 'Distancia', 'Area': 'Superficie', 'Perimeter': 'Per√≠metro'
        };
        const ctrl = document.querySelector('.leaflet-control-measure');
        if(ctrl) {
            const btn = ctrl.querySelector('.leaflet-control-measure-toggle');
            if(btn) btn.title = "Medir";
            ctrl.querySelectorAll('*').forEach(el => {
                if(trans[el.innerText]) el.innerText = trans[el.innerText];
                if(trans[el.title]) el.title = trans[el.title];
            });
        }
    }
    new MutationObserver(translateMeasure).observe(document.body, { childList: true, subtree: true });

    // PANE ETIQUETAS
    map.createPane('labelsPane');
    map.getPane('labelsPane').style.zIndex = 650;
    map.getPane('labelsPane').style.pointerEvents = 'none';

    // CAPAS
    var pnoa = L.tileLayer.wms("https://www.ign.es/wms-inspire/pnoa-ma", { layers: "OI.OrthoimageCoverage", format: "image/jpeg", attribution: "PNOA", maxZoom: 20 }).addTo(map);
    var osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: "OSM" });
    
    var limites = L.tileLayer.wms("https://www.ign.es/wms-inspire/unidades-administrativas", { layers: 'AU.AdministrativeBoundary', format: 'image/png', transparent: true, zIndex: 1000, className: 'violet-wms' }).addTo(map);
    var poblaciones = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}{r}.png', { pane: 'labelsPane', subdomains: 'abcd', maxZoom: 20 }).addTo(map);
    
    var faixa50m = L.esri.dynamicMapLayer({ url: "https://ideg.xunta.gal/servizos-c08/rest/services/VISFPI/FaixasProteccionIncendios/MapServer", layers: [2], opacity: 0.65, zIndex: 400 }).addTo(map);
    var nucleos = L.esri.dynamicMapLayer({ url: "https://ideg.xunta.gal/servizos-c08/rest/services/VISFPI/FaixasProteccionIncendios/MapServer", layers: [1], opacity: 0.5, zIndex: 390 });
    var catastro = L.tileLayer.wms("http://ovc.catastro.meh.es/cartografia/INSPIRE/spadgcwms.aspx", { layers: "CP.CadastralParcel", format: 'image/png', transparent: true, zIndex: 380, minZoom: 14 });

    // MINIMAPA (Posici√≥n: bottomleft)
    new L.Control.MiniMap(new L.TileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"), { 
        toggleDisplay: true, 
        minimized: false,
        position: 'bottomleft', // Se alinea con CSS
        width: 120, 
        height: 120 
    }).addTo(map);

    // CONTROL CAPAS
    var baseMaps = { "üõ∞Ô∏è Sat√©lite": pnoa, "üó∫Ô∏è Mapa": osm };
    var overlays = {
        "<span class='layer-label'><span class='color-box' style='border: 3px solid #9932CC; background:none;'></span> L√≠mites Municipales</span>": limites,
        "üèòÔ∏è Poblaciones": poblaciones,
        "<span class='layer-label'><span class='color-box' style='background:rgba(255,0,0,0.5)'></span> Faixa 50m</span>": faixa50m,
        "<span class='layer-label'><span class='color-box' style='background:rgba(255,165,0,0.5)'></span> N√∫cleo rural</span>": nucleos,
        "üèóÔ∏è Catastro (> Z14)": catastro
    };
    L.control.layers(baseMaps, overlays, { collapsed: true }).addTo(map);
    L.control.scale({ imperial: false, position: 'bottomleft' }).addTo(map);

    // POPUP INFO
    map.on('click', function(e) {
        if(document.querySelector('.leaflet-control-measure-interaction')) return;
        L.esri.identifyFeatures({ url: 'https://ideg.xunta.gal/servizos-c08/rest/services/VISFPI/FaixasProteccionIncendios/MapServer' })
        .on(map).at(e.latlng).layers('visible:1,2').run(function(error, featureCollection) {
            if (featureCollection && featureCollection.features.length > 0) {
                var content = '<div class="info-popup-header">Informaci√≥n</div><table class="info-popup-table">';
                var props = featureCollection.features[0].properties;
                for (var k in props) {
                    if (k !== 'OBJECTID' && k !== 'Shape' && k !== 'pixel' && k!='Shape.area' && k!='Shape.len') 
                        content += `<tr><td><b>${k}:</b></td><td>${props[k]}</td></tr>`;
                }
                content += '</table>';
                L.popup().setLatLng(e.latlng).setContent(content).openOn(map);
            }
        });
    });

    // GEOLOCALIZACI√ìN
    const btn = document.getElementById('btnLocateMain');
    btn.addEventListener('click', function() {
        if (location.protocol !== 'https:' && location.hostname !== 'localhost') return alert("Requiere HTTPS");
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
        map.locate({ setView: true, maxZoom: 16, enableHighAccuracy: false }); // False para evitar timeout en PC
    });
    map.on('locationfound', e => {
        btn.innerHTML = '<i class="fa-solid fa-check"></i> OK';
        setTimeout(() => btn.innerHTML = '<i class="fa-solid fa-location-crosshairs"></i> Centrar', 2000);
        
        // C√≠rculo de precisi√≥n SUTIL (Fix: opacidad baja para ver debajo)
        L.circle(e.latlng, { 
            radius: e.accuracy, 
            color: '#007bff', 
            weight: 1, 
            fillColor: '#007bff', 
            fillOpacity: 0.1 // Muy transparente
        }).addTo(map).bindPopup("Precisi√≥n aprox: " + Math.round(e.accuracy) + "m");
        
        // Marcador
        L.circleMarker(e.latlng, {radius:6, color:'white', weight:2, fillColor:'#007bff', fillOpacity:1}).addTo(map);
    });
    map.on('locationerror', () => {
        alert("No se pudo obtener la ubicaci√≥n.");
        btn.innerHTML = '<i class="fa-solid fa-location-crosshairs"></i> Centrar';
    });

    // IA & CONTROLES FLOTANTES
    var floatCtrl = L.Control.extend({ options: { position: 'bottomright' }, onAdd: function() {
        var d = L.DomUtil.create('div');
        d.innerHTML = '<a href="#" class="floating-btn ai-btn" onclick="toggleAI()"><i class="fa-solid fa-wand-magic-sparkles"></i></a>';
        return d;
    }});
    map.addControl(new floatCtrl());

    const apiKey = ""; // INYECTADA POR ENTORNO
    function toggleAI() { document.getElementById('aiModal').style.display = document.getElementById('aiModal').style.display==='flex'?'none':'flex'; }
    function askPreset(t) { document.getElementById('userQuery').value=t; callGemini(); }
    function handleEnter(e) { if(e.key==='Enter') callGemini(); }
    
    async function callGemini() {
        const q = document.getElementById('userQuery').value;
        if(!q) return;
        const chat = document.getElementById('chatContainer');
        chat.innerHTML += `<div class="message msg-user">${q}</div>`;
        document.getElementById('userQuery').value = '';
        
        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ contents: [{ parts: [{ text: "Eres experto forestal Galicia (Ley 3/2007). Responde brevemente: " + q }] }] })
            });
            const data = await res.json();
            chat.innerHTML += `<div class="message msg-ai">${data.candidates[0].content.parts[0].text}</div>`;
            chat.scrollTop = chat.scrollHeight;
        } catch(e) { chat.innerHTML += `<div class="message msg-ai">Error de conexi√≥n.</div>`; }
    }
  </script>
</body>
</html>
